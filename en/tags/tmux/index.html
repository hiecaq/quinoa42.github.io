<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width" />
    
    <link rel="stylesheet" href="https://quinoa42.github.io/style/site.min.css">
    <title>
  tmux &ndash; Emain Ablach
</title>
  </head>
  <body>
    <header id="header">
      <div class="logo"><a href="https://quinoa42.github.io/">Emain Ablach</a></div>
      <nav class="jumplist">
        <ul>
          
          <li><a href="https://quinoa42.github.io/en/oceanus/">Oceanus</a></li>
          
          <li><a href="https://quinoa42.github.io/en/whimsia/">Whimsia</a></li>
          
        </ul>
      </nav>
    </header>
    <main>
    
  
      <article class="post-item">
        <header>
          <div class="tt">
            <h1><a href="/en/oceanus/tridactyl-editorcmd-with-tmux/">Open tridactyl&#39;s external editor in a new tmux window</a></h1>
            <time>01-20-2019</time>
          </div>
          <div class="reading-info">
            <div class="left">
             <div class="tags">
    &#x1f3f7;
    <nav class="jumplist">
        <ul>
          
    
    
    <li><a href="https://quinoa42.github.io/en/categories/software/">software</a></li>
    


          
    
    
    <li><a href="https://quinoa42.github.io/en/tags/tmux/">tmux</a></li>
    

    
    
    <li><a href="https://quinoa42.github.io/en/tags/firefox/">Firefox</a></li>
    


        </ul>
    </nav>
</div>

            </div>
            <div class="right">
              <span>415 words</span>
              <span>
                &bull;
              </span>
              <span>2 min read</span>
            </div>
          </div>
        </header>
        

<p><a href="https://github.com/tridactyl/tridactyl">Tridactyl</a> has been a decent replacement for <a href="https://github.com/vimperator/vimperator-labs">Vimperator</a> or <a href="https://github.com/5digits/dactyl">Pentadactyl</a> for me since I said goodbye to the XUL extensions. It supports the invocation of external editor (I mean Vim, of course) in its own insert mode pretty well, but the default behavior is to open Vim in a new terminal emulator window. Considering that I&rsquo;m using <code>tmux</code> for most of the time, I start to wondering if I could do some tweak with the <code>editorcmd</code> so that instead of a new terminal emulator window, a termporary tmux window will be opened.</p>

<h2 id="first-attempt">First attempt</h2>

<p>How <code>editorcmd</code> works is pretty simple: once the user invokes <code>editor()</code>, tridactyl will expand the first occurrence of <code>%f</code> into the filepath for the tempfile, or just append the filepath at the end if <code>%f</code> is not found (see <a href="https://github.com/tridactyl/tridactyl/blob/ddfb5b5/src/excmds.ts#L255">this</a> for details). So we could easily come up with the following code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">set editorcmd tmux new-window -n firefox &#39;nvim -f %f&#39;</code></pre></div>
<p>However, this actually doesn&rsquo;t work the way we want. What happens is that <code>tmux new-window</code> doesn&rsquo;t block until the window is closed. As a result, once the given command has returned, tridactyl will go straight to read from the provided tempfile, which will turn out to be empty since it&rsquo;s just opened by the Neovim in the new tmux window. We need to find a way to block the command until the window is closed.</p>

<h2 id="solution">Solution</h2>

<p>A <a href="https://unix.stackexchange.com/a/137547">StackExchange answer</a> points out the solution: to use <code>tmux wait-for</code>. <code>tmux wait-for &lt;CHANNEL&gt;</code> will block until receiving the signal on the given <code>CHANNEL</code>, while <code>tmux wait-for -S &lt;CHANNEL&gt;</code> will send such a signal to the <code>CHANNEL</code>. Thus, the solution will be:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">set editorcmd tmux new-window -n firefox &#39;nvim -f %f; tmux wait-for -S firefox-neww-done&#39; \; wait-for firefox-neww-done</code></pre></div>
<p>This binding divides into two sequential command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">new-window -n firefox <span style="color:#e6db74">&#39;nvim -f %f; tmux wait-for -S firefox-neww-done&#39;</span>
wait-for firefox-neww-done</code></pre></div>
<p><code>\;</code> is to make sure the shell will not interpret this <code>;</code> so that it can be passed to <code>tmux</code>, where it also serves the purpose of dividing the commands (see the <a href="http://man.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man1/tmux.1#COMMANDS">manpage</a> for details).</p>

<p>So in this new version, the second line will block until the first line returned, where in the first line the signal will not be sent until Neovim is closed. Once the signal is sent, the new <code>tmux</code> window will also be closed too. Everything works as expected!</p>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="https://unix.stackexchange.com/a/137547">answer to the question &lsquo;Make tmux block until program completes&rsquo; by Chris Johnsen</a></li>
<li><a href="http://man.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man1/tmux.1#COMMANDS">Manpage of tmux on OpenBSD</a></li>
<li><a href="https://github.com/tridactyl/tridactyl/blob/ddfb5b5/src/excmds.ts#L255">tridactyl source code on editorcmd</a></li>
</ul>

      </article>
  
      <article class="post-item">
        <header>
          <div class="tt">
            <h1><a href="/en/oceanus/tmux-force-utf8/">Fix display of special characters of tmux under ssh with t flag</a></h1>
            <time>04-09-2017</time>
          </div>
          <div class="reading-info">
            <div class="left">
             <div class="tags">
    &#x1f3f7;
    <nav class="jumplist">
        <ul>
          
    
    
    <li><a href="https://quinoa42.github.io/en/categories/software/">software</a></li>
    


          
    
    
    <li><a href="https://quinoa42.github.io/en/tags/ssh/">ssh</a></li>
    

    
    
    <li><a href="https://quinoa42.github.io/en/tags/tmux/">tmux</a></li>
    


        </ul>
    </nav>
</div>

            </div>
            <div class="right">
              <span>182 words</span>
              <span>
                &bull;
              </span>
              <span>1 min read</span>
            </div>
          </div>
        </header>
        <p>I am used to use tmux on our server via ssh with the simple but elegant command <code>ssh blabla@hostname -t tmux</code>, but today I suddenly realized that under my tmux all the Unicode special characters doesn&rsquo;t display correctly for some reason. If I remembered correctly they did display without any fault just yesterday, but anyway after a few minutes I found (probably) a solution to this problem.</p>

<p>Firstly I checked that if I simply <code>ssh blabla@hostname</code> and then <code>tmux</code> to generate or attach to a session, the session does show those characters correctly. Also, if I run <code>ssh blabla@hostname -t nvim</code>, Unicode special characters I set in my <code>Neovim</code> status line also display correctly. So I confirm that the problem is probably caused by <code>-t</code> flag, which is said to <code>force pseudo-terminal allocation</code>, by <code>man</code> page.</p>

<p>So I guess <code>tmux</code> called under <code>ssh -t</code> thinks that <code>UTF-8</code> is not supported. The solution is quite simple, because tmux supports <code>-u</code> flag:</p>

<blockquote>
<p>the -u flag explicitly informs tmux that UTF-8 is supported.</p>
</blockquote>

<p>So, just start tmux with <code>-u</code> flag:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh blabla@hostname -t tmux -u</code></pre></div>
      </article>
  
      <article class="post-item">
        <header>
          <div class="tt">
            <h1><a href="/en/oceanus/terminfo-truecolor/">Terminfo for iterm2 and tmux that support italics, truecolor and fixed ctrl-h</a></h1>
            <time>11-23-2016</time>
          </div>
          <div class="reading-info">
            <div class="left">
             <div class="tags">
    &#x1f3f7;
    <nav class="jumplist">
        <ul>
          
    
    
    <li><a href="https://quinoa42.github.io/en/categories/software/">software</a></li>
    


          
    
    
    <li><a href="https://quinoa42.github.io/en/tags/terminal/">terminal</a></li>
    

    
    
    <li><a href="https://quinoa42.github.io/en/tags/tmux/">tmux</a></li>
    


        </ul>
    </nav>
</div>

            </div>
            <div class="right">
              <span>236 words</span>
              <span>
                &bull;
              </span>
              <span>2 min read</span>
            </div>
          </div>
        </header>
        

<p>Everyone likes true color. But the true color support doesn&rsquo;t come out of the box for most terminal emulators, and some of them are just never going to support it. However, for some of them with some simple tweak true color will just simply be available.</p>

<h2 id="iterm2">iterm2</h2>

<p>Make a new file called <code>term-256color-italic.terminfo</code>, and add these:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># A xterm-256color based TERMINFO that adds the escape sequences for italic.
xterm-256color-italic|xterm with 256 colors and italic,
  sitm=\E[3m, ritm=\E[23m,
  kbs=\177,
  use=xterm-256color,</code></pre></div>
<p>then,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">tic xterm-256color-italic.terminfo</code></pre></div>
<p>Open iterm&rsquo;s <code>Preferences/profiles/Terminal</code> page, and edit <code>Report Terminal Type</code> into <code>xterm-256color-italic</code>.</p>

<p>iTerm natively support true color.</p>

<h2 id="tmux">tmux</h2>

<p>Make a new file called <code>tmux.terminfo</code>, and add these:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># A screen-256color based TERMINFO that adds the escape sequences for italic.
# run to add to term db: tic -x tmux.terminfo
tmux|tmux terminal multiplexer,
  ritm=\E[23m, rmso=\E[27m, sitm=\E[3m, smso=\E[7m, Ms@,
  use=xterm, use=screen,
  kbs=\177,

tmux-256color|tmux with 256 colors,
  use=xterm-256color, use=tmux,
  kbs=\177,</code></pre></div>
<p>then,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">tic -x tmux.terminfo</code></pre></div>
<p>Also add these to your <code>.tmux.conf</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-tmux" data-lang="tmux"># use italic
set -g default-terminal &#34;tmux-256color&#34;
# true color!!!
set-option -ga terminal-overrides &#34;,xterm-256color-italic:Tc&#34;</code></pre></div>
<h2 id="neovim">neovim</h2>

<p>Now , time to set up neovim (using
<a href="https://github.com/icymind/NeoSolarized">NeoSolarized</a>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vimrc" data-lang="vimrc"><span style="color:#75715e">&#34; enable 256 colors</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#a6e22e">set</span> <span style="color:#a6e22e">t_Co</span>=<span style="color:#ae81ff">256</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">has</span>(<span style="color:#e6db74">&#39;nvim&#39;</span>) <span style="color:#75715e">&#34; enable true color</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#a6e22e">set</span> <span style="color:#a6e22e">termguicolors</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#a6e22e">set</span> <span style="color:#a6e22e">t_8f</span>=^[[<span style="color:#ae81ff">38</span>;<span style="color:#ae81ff">2</span>;%<span style="color:#a6e22e">lu</span>;%<span style="color:#a6e22e">lu</span>;%<span style="color:#a6e22e">lum</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#a6e22e">set</span> <span style="color:#a6e22e">t_8b</span>=^[[<span style="color:#ae81ff">48</span>;<span style="color:#ae81ff">2</span>;%<span style="color:#a6e22e">lu</span>;%<span style="color:#a6e22e">lu</span>;%<span style="color:#a6e22e">lum</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">endif</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">
</span><span style="color:#75715e">&#34; color theme</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#a6e22e">colorscheme</span> <span style="color:#a6e22e">NeoSolarized</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">&#34; set background type</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#a6e22e">set</span> <span style="color:#a6e22e">background</span>=dark</code></pre></div>
<p>Note that <code>^[</code> is the special character <code>\e</code>.</p>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="https://github.com/icymind/NeoSolarized">NeoSolarized</a></li>
<li><a href="https://alexpearce.me/2014/05/italics-in-iterm2-vim-tmux/">Italic fonts in iTerm2, tmux, and vim</a></li>
<li><a href="http://apple.stackexchange.com/a/249385">Answer by Bret Fisher in a question on AskDifferent</a></li>
<li><a href="https://github.com/neovim/neovim/wiki/FAQ#my-ctrl-h-mapping-doesnt-work">Solution to fix ctrl-h for neovim</a></li>
</ul>

      </article>
  

    </main>
    <footer id="footer">
    
    <hr />
    <div><a href="https://github.com/quinoa42">GitHub</a></div>
    <div><a href="https://bgm.tv/user/112851">Bangumi</a></div>
    <div><a href="https://myanimelist.net/profile/quinoa42">MyAnimeList</a></div>
    
    </footer>
  </body>
</html>
